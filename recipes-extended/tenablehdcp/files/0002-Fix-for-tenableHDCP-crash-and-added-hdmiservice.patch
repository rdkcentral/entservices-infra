From 0472a1c51fbf0c362072b5a4545db6a9d30d9903 Mon Sep 17 00:00:00 2001
From: yuvaramachandran_gurusamy <yuvaramachandran_gurusamy@comcast.com>
Date: Fri, 26 Sep 2025 15:11:11 +0000
Subject: [PATCH] RDKEMW-7840: Exception handling and retry added in
 tenableHDCP and hdcp service

Signed-off-by: yuvaramachandran_gurusamy <yuvaramachandran_gurusamy@comcast.com>
---
 conf/hdcp.service |  6 ++++--
 tenableHDCP.cpp   | 15 ++++++++++++---
 2 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/conf/hdcp.service b/conf/hdcp.service
index 44c40d63..9316de74 100755
--- a/conf/hdcp.service
+++ b/conf/hdcp.service
@@ -18,10 +18,12 @@
 ##########################################################################
 [Unit]
 Description=HDCP Service
-After=dsmgr.service iarmbusd.service
+After=dsmgr.service iarmbusd.service hdmiservice.service
 
 [Service]
-ExecStart=/bin/sh -c '/usr/bin/tenableHDCP true >& /var/log/hdcp.log '
+ExecStart=/bin/sh -c '/usr/bin/tenableHDCP true >> /opt/logs/hdcp.log 2>&1'
+RestartSec=5s
+Restart=on-failure
 
 [Install]
 WantedBy=multi-user.target
diff --git a/tenableHDCP.cpp b/tenableHDCP.cpp
index 90de10c3..c9ff9d06 100644
--- a/tenableHDCP.cpp
+++ b/tenableHDCP.cpp
@@ -36,14 +36,17 @@
 
 int main(int argc, char *argv[])
 {
+    int returnValue = 0;
     if (argc != 2) {
         printf("Usage: %s : <true|false>\n", argv[0]);
-        return 0;
+        return -1;
     }
 
     IARM_Bus_Init("enableHDCPclient");
     IARM_Bus_Connect();
 
+    try
+    {
     device::Manager::Initialize();
 
 
@@ -129,12 +132,18 @@ Patch to remove the mfr dependency for enabling hdcp. Devicesettings hal handle
         }
     }
     catch (...) {
-	    printf("Exception Caught during [%s]\r\n", argv[0]);
+        printf("Exception Caught during enabledHDCP for [%s]\r\n", argv[0]);
+        returnValue = -1;
     }
 
     device::Manager::DeInitialize();
+    }
+    catch (...) {
+        printf("Exception Caught during initialize for [%s]\r\n", argv[0]);
+        returnValue = -1;
+    }
 
     IARM_Bus_Disconnect();
     IARM_Bus_Term();
-    return 0;
+    return returnValue;
 }
-- 
2.25.1

